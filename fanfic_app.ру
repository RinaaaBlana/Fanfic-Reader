import streamlit as st
import os
from pathlib import Path
import base64

st.set_page_config(
    page_title="üìñ FanFic Reader Mobile",
    page_icon="üìö",
    layout="centered"
)

# –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
st.markdown("""
<style>
    .fanfic-text {
        font-family: 'Georgia', serif;
        font-size: 18px;
        line-height: 1.8;
        padding: 10px;
    }
    .stButton > button {
        width: 100%;
        margin: 5px 0;
    }
</style>
""", unsafe_allow_html=True)

class FanficLibrary:
    def __init__(self):
        self.lib_path = Path("./fanfics")
        self.lib_path.mkdir(exist_ok=True)
    
    def save_fanfic(self, title, text):
        filename = title.replace(" ", "_") + ".txt"
        (self.lib_path / filename).write_text(text, encoding='utf-8')
        return filename
    
    def get_fanfics(self):
        return [f.stem.replace("_", " ") for f in self.lib_path.glob("*.txt")]
    
    def read_fanfic(self, title):
        filename = title.replace(" ", "_") + ".txt"
        return (self.lib_path / filename).read_text(encoding='utf-8')

def main():
    st.title("üìñ –ß–∏—Ç–∞–ª–∫–∞ —Ñ–∞–Ω—Ñ–∏–∫–æ–≤")
    st.markdown("---")
    
    library = FanficLibrary()
    
    # –í–∫–ª–∞–¥–∫–∏
    tab1, tab2, tab3 = st.tabs(["üìö –ú–æ–∏ —Ñ–∞–Ω—Ñ–∏–∫–∏", "‚ûï –î–æ–±–∞–≤–∏—Ç—å", "üìñ –ß–∏—Ç–∞—Ç—å"])
    
    with tab1:
        st.header("–í–∞—à–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞")
        fanfics = library.get_fanfics()
        
        if not fanfics:
            st.info("–ü–æ–∫–∞ –Ω–µ—Ç —Ñ–∞–Ω—Ñ–∏–∫–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –≤–æ –≤–∫–ª–∞–¥–∫–µ '–î–æ–±–∞–≤–∏—Ç—å'!")
        else:
            for i, title in enumerate(fanfics):
                col1, col2 = st.columns([3, 1])
                with col1:
                    st.write(f"**{title}**")
                with col2:
                    if st.button("–ß–∏—Ç–∞—Ç—å", key=f"read_{i}"):
                        st.session_state['reading'] = title
                        st.rerun()
    
    with tab2:
        st.header("–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–Ω—Ñ–∏–∫")
        
        title = st.text_input("–ù–∞–∑–≤–∞–Ω–∏–µ:")
        content = st.text_area("–¢–µ–∫—Å—Ç —Ñ–∞–Ω—Ñ–∏–∫–∞:", height=300)
        
        if st.button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", type="primary"):
            if title and content:
                library.save_fanfic(title, content)
                st.success(f"‚úÖ '{title}' —Å–æ—Ö—Ä–∞–Ω–µ–Ω!")
                st.balloons()
    
    with tab3:
        if 'reading' in st.session_state:
            st.header(f"üìñ {st.session_state['reading']}")
            
            content = library.read_fanfic(st.session_state['reading'])
            
            # –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å –∑–∞–∫–ª–∞–¥–∫–æ–π
            lines = content.split('\n')
            for i, line in enumerate(lines):
                if line.strip():
                    st.markdown(f'<div class="fanfic-text">{line}</div>', unsafe_allow_html=True)
            
            if st.button("‚Üê –ù–∞–∑–∞–¥"):
                del st.session_state['reading']
                st.rerun()
        else:
            st.info("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–Ω—Ñ–∏–∫ –¥–ª—è —á—Ç–µ–Ω–∏—è –≤–æ –≤–∫–ª–∞–¥–∫–µ '–ú–æ–∏ —Ñ–∞–Ω—Ñ–∏–∫–∏'")

if __name__ == "__main__":
    main()
